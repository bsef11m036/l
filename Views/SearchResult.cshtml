@using System.Security.Claims;
@model FYP.Models.Search
@{
    Layout = null;
}
<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<link href="~/Content/bootstrap.css" rel="stylesheet" />
<link href="~/Content/search.css" rel="stylesheet" />
<script src="~/Scripts/bootstrap.js"></script>
<link href="~/Content/Chat.css" rel="stylesheet" />
<script src="~/Scripts/jquery.signalR-2.0.0.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="/signalr/hubs"></script>
<script type="text/javascript">

    function getCurrentDate() {
        var d = new Date($.now());
        var day = d.getDate() + "";
        if (day.length == 1) {
            day = "0" + day;
        }
        var month = (d.getMonth() + 1) + "";
        if (month.length == 1) {
            month = "0" + month;
        }
        var year = d.getFullYear() + "";

        var hours = d.getHours() + "";
        if (hours.length == 1) {
            hours = "0" + hours;
        }
        var minutes = d.getMinutes() + "";
        if (minutes.length == 1) {
            minutes = "0" + minutes;
        }
        var seconds = d.getSeconds() + "";
        if (seconds.length == 1) {
            seconds = "0" + seconds;
        }
        var fullDate = day + "/" + month + "/" + year + " " + hours + ":" + minutes + ":" + seconds;
        return fullDate;
    }
    function abc(chatHub) {
        var b = $("#uname").val();
        $(document).ready(function connectToChatting() {
            name = b;
            chatHub.server.connect(name);
        })
        $("#btnChat").click(function () {
            var title = document.getElementById('chatTitle');
            var z = title.innerHTML;
            var x = $("#chatMsg").val();
            if (x != "") {
                $("#app").append('<div class="row msg_container base_receive" ><div class="col-md-2 col-xs-2 avatar"><img src="' + 'Account/GetImage?UserName=' + b + '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive" style="background-color:#00CCFF"><p>' + x + '</p><time datetime="2009-11-13T20:00">' + z + ' • ' + getCurrentDate() + '</time></div></div></div>');
                $("#chatMsg").val(null);
                var date = getCurrentDate();
                chatHub.server.sendMessage(z, x, date);
                charHub.server.addMessageinCache(b, x, z);
            }
        })
        $("#chatMsg").keypress(function (event) {
            if (event.which == 13) {
                var title = document.getElementById('chatTitle');
                var z = title.innerHTML;
                var x = $("#chatMsg").val();
                if (x != "") {
                    $("#app").append('<div class="row msg_container base_receive" ><div class="col-md-2 col-xs-2 avatar"><img src="' + 'Account/GetImage?UserName=' + b + '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive" style="background-color:#00CCFF"><p>' + x + '</p><time datetime="2009-11-13T20:00">' + z + ' • ' + getCurrentDate() + '</time></div></div></div>');
                    $("#chatMsg").val(null);
                    var date = getCurrentDate();
                    chatHub.server.sendMessage(z, x, date);
                    charHub.server.addMessageinCache(b, x, z);
                }
            }
        });
        $('.status').click(function () {
            var y = $(this).text();
            var x = $(this).siblings().text();
            var title = document.getElementById("chatTitle");
            var z = title.innerHTML;
            if ("Chat" == y && (z == "" || z == x)) {
                $('.chatBox').show();
                title.innerHTML = x;
                title.className = "panel-title";
                chatHub.server.getOldMessages(b, x);
            }
        });
    }
    function registerClientMethods(chatHub) {
        // Calls when user successfully logged in
        chatHub.client.onConnected = function (id, userName, allUsers, messages) {
            var arr1 = document.getElementsByClassName('username');
            var arr2 = document.getElementsByClassName('status');
            for (var i = 0; i < arr1.length; i++) {
                var t = arr1[i].innerHTML;
                for (var j = 0; j < allUsers.length; j++) {
                    if (t == allUsers[j].UserName) {
                        arr2[i].innerHTML = "Chat";
                        arr2[i].className = "status pull-right btn-primary";
                    }
                }
            }
        }
        chatHub.client.onNewUserConnected = function (id, userName) {
            var arr1 = document.getElementsByClassName('username');
            var arr2 = document.getElementsByClassName('status');

            for (var i = 0; i < arr1.length; i++) {
                var t = arr1[i].innerHTML;
                if (t == userName) {
                    arr2[i].innerHTML = "Chat";
                    arr2[i].className = "status pull-right btn-primary";
                }
                else {
                    arr2[i].innerHTML = "Send Mail";
                    arr2[i].className = "status pull-right btn-danger";
                }
            }
        }
        chatHub.client.onUserDisconnected = function (id, userName) {
            var arr1 = document.getElementsByClassName('username');
            var arr2 = document.getElementsByClassName('status');

            for (var i = 0; i < arr1.length; i++) {
                var t = arr1[i].innerHTML;
                if (t == userName) {
                    arr2[i].innerHTML = "Send Mail";
                    arr2[i].className = "status pull-right btn-danger";
                }
            }
        }
        chatHub.client.sendPrivateMessage = function (fromUserId, fromUser, toUser, message, previousMessages) {
            var title = document.getElementById("chatTitle");
            var z = title.innerHTML;
            $('.chatBox').show();
            var b = $("#uname").val();
            if (isEmpty($("#app"))) {
                var i = 0;
                for (i = 0; i < previousMessages.length; i++) {
                    var z = previousMessages[i].From;
                    if (z == b) {
                        $("#app").append('<div class="row msg_container base_receive" ><div class="col-md-2 col-xs-2 avatar"><img src="' + '/Account/GetImage?UserName=' + previousMessages[i].From + '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive" style="background-color:#00CCFF"><p>' + previousMessages[i].MessageText + '</p><time datetime="2009-11-13T20:00">' + previousMessages[i].To + ' •' + previousMessages[i].Date + '</time></div></div></div>');

                    }
                    else {
                        $("#app").append('<div class="row msg_container base_sent" ><div class="col-md-10 col-xs-10"><div class="messages msg_sent" style="background-color:#00FF66"><p>' + previousMessages[i].MessageText + '</p><time datetime="2009-11-13T20:00">' + previousMessages[i].From + ' • ' + previousMessages[i].Date + '</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' + '/Account/GetImage?UserName=' + z + '" class=" img-responsive "></div></div></div>');
                    }
                }
            }
            if (title.innerHTML == fromUser || title.innerHTML == "") {
                title.innerHTML = fromUser;
                $("#app").append('<div class="row msg_container base_sent"><div class="col-md-10 col-xs-10"><div class="messages msg_sent" style="background-color:#00FF66"><p>' + message + '</p><time datetime="2009-11-13T20:00">' + fromUser + ' • ' + getCurrentDate() + '</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' + '/Account/GetImage?UserName=' + fromUser + '" class=" img-responsive "></div></div></div>');
                title.className = "panel-title";
                $this.parents('.panel').find('.panel-body').slideDown();
            }
            else {
                //open a new chat box
            }
        }
        function isEmpty(el) {
            return !$.trim(el.html());
        }
        chatHub.client.addOldMessages = function (messages) {
            if (isEmpty($("#app"))) {
                var b = $("#uname").val();
                var i = 0;
                for (i = 0; i < messages.length; i++) {
                    var z = messages[i].From;
                    if (z == b) {
                        $("#app").append('<div class="row msg_container base_receive" ><div class="col-md-2 col-xs-2 avatar"><img src="' + '/Account/GetImage?UserName=' + messages[i].From + '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive" style="background-color:#00CCFF"><p>' + messages[i].MessageText + '</p><time datetime="2009-11-13T20:00">' + messages[i].To + ' •' + messages[i].Date + '</time></div></div></div>');

                    }
                    else {
                        $("#app").append('<div class="row msg_container base_sent" ><div class="col-md-10 col-xs-10"><div class="messages msg_sent" style="background-color:#00FF66"><p>' + messages[i].MessageText + '</p><time datetime="2009-11-13T20:00">' + messages[i].From + ' • ' + messages[i].Date + '</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' + '/Account/GetImage?UserName=' + z + '" class=" img-responsive "></div></div></div>');
                    }
                }
            }
        }
    }
    $(function () {
        // Declare a proxy to reference the hub.
        var chatHub = $.connection.chatHub;
        registerClientMethods(chatHub);
        // Start Hub
        $.connection.hub.start().done(function () {
            abc(chatHub);
        });
    });

</script>
<script>
    $(document).ready(function () {
        $('.chatBox').hide();
        $('.chatBox1').hide();
        $('.chatBox2').hide();
    })
</script>
<script>
</script>
<script>
    $(document).on('click', '.panel-heading span.icon_minim', function (e) {
        var $this = $(this);
        if (!$this.hasClass('panel-collapsed')) {
            $this.parents('.panel').find('.panel-body').slideUp();
            $this.addClass('panel-collapsed');
            $this.removeClass('glyphicon-minus').addClass('glyphicon-plus');
        } else {
            $this.parents('.panel').find('.panel-body').slideDown();
            $this.removeClass('panel-collapsed');
            $this.removeClass('glyphicon-plus').addClass('glyphicon-minus');
        }
    });
    $(document).on('focus', '.panel-footer input.chat_input', function (e) {
        var $this = $(this);
        if ($('#minim_chat_window').hasClass('panel-collapsed')) {
            $this.parents('.panel').find('.panel-body').slideDown();
            $('#minim_chat_window').removeClass('panel-collapsed');
            $('#minim_chat_window').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        }
    });
    $(document).on('click', '#new_chat', function (e) {
        var size = $(".chat-window:last-child").css("margin-right");
        size_total = parseInt("600") + size;
        alert(size_total);
        var clone = $("#chat_window_1").clone().appendTo(".container");
        clone.css("margin-right", size_total);
    });
    $(document).on('click', '.icon_close', function (e) {
        //$(this).parent().parent().parent().parent().remove();
        $(".chatBox").hide();
    });
</script>
<br />
<div class="container">
    <hgroup class="mb20">
        <h1>Search Results</h1>
        <h2 class="lead"><strong class="text-danger">@ViewBag.search.Count</strong> results were found for the search for <strong class="text-danger">@ViewBag.query</strong></h2>
    </hgroup>

    <section class="col-xs-12 col-sm-6 col-md-12">
        @foreach (FYP.Models.Search s in ViewBag.search)
        {
            <article class="result search-result row">
                <div class="col-xs-12 col-sm-12 col-md-3">
                    <a href="#" class="thumbnail"><img src=@Url.Action("GetImage", "Account", new { UserName = s.UserName })></a>
                </div>
                <div class="col-xs-12 col-sm-12 col-md-2">
                    <ul class="meta-search">
                        <li><i class="glyphicon glyphicon-calendar"></i> <span>@s.Date</span></li>
                        <li><i class="glyphicon glyphicon-time"></i> <span>@s.Time</span></li>
                        <li><i class="glyphicon glyphicon-tags"></i> <span>People</span></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-12 col-md-7 excerpet">
                    <h3>
                        <a href="#" class="username" id="UserNo">@s.UserName</a>
                        <button id="chatButton" class="status pull-right btn-danger" style="font-size:x-large">Send Mail</button>
                    </h3>
                    <p>@s.SearchQuery</p>
                </div>
                <span class="clearfix borda"></span>
            </article>
        }
    </section>
</div>
<div class="chatBox">
    <div class="container">
        <div class="row chat-window col-xs-5 col-md-4" id="chat_window_1" style="margin-left:10px">
            <div class="col-xs-12 col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading top-bar">
                        <div class="col-md-8 col-xs-8">
                            <h3 class="panel-title"><span class="glyphicon glyphicon-comment">Chat-</span><span id="chatTitle"></span></h3>
                        </div>
                        <div class="col-md-4 col-xs-4" style="text-align: right;">
                            <a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a>
                            <a href="#"><span class="glyphicon glyphicon-remove icon_close" data-id="chat_window_1"></span></a>
                        </div>
                    </div>
                    <div id="msg" class="panel-body msg_container_base">
                        <div id="app">
                        </div>
                        <div class="panel-footer">
                            <div class="input-group">
                                <input id="chatMsg" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." />
                                <span class="input-group-btn">
                                    <button class="btn btn-primary btn-sm" id="btnChat">Send</button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<div class="chatBox1">
    <div class="container">
        <div class="row chat-window1 col-xs-5 col-md-4" id="chat_window_1">
            <div class="col-xs-12 col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading top-bar">
                        <div class="col-md-8 col-xs-8">
                            <h3 class="panel-title"><span class="glyphicon glyphicon-comment">Chat-</span><span id="chatTitle"></span></h3>
                        </div>
                        <div class="col-md-4 col-xs-4" style="text-align: right;">
                            <a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a>
                            <a href="#"><span class="glyphicon glyphicon-remove icon_close" data-id="chat_window_1"></span></a>
                        </div>
                    </div>
                    <div class="panel-body msg_container_base">
                        <div id="app">
                        </div>
                        <div class="panel-footer">
                            <div class="input-group">
                                <input id="chatMsg" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." />
                                <span class="input-group-btn">
                                    <button class="btn btn-primary btn-sm" id="btnChat">Send</button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<div class="chatBox2">
    <div class="container">
        <div class="row chat-window2 col-xs-5 col-md-4" id="chat_window_1">
            <div class="col-xs-12 col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading top-bar">
                        <div class="col-md-8 col-xs-8">
                            <h3 class="panel-title"><span class="glyphicon glyphicon-comment">Chat-</span><span id="chatTitle"></span></h3>
                        </div>
                        <div class="col-md-4 col-xs-4" style="text-align: right;">
                            <a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a>
                            <a href="#"><span class="glyphicon glyphicon-remove icon_close" data-id="chat_window_1"></span></a>
                        </div>
                    </div>
                    <div class="panel-body msg_container_base">
                        <div id="app">
                        </div>
                        <div class="panel-footer">
                            <div class="input-group">
                                <input id="chatMsg" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." />
                                <span class="input-group-btn">
                                    <button class="btn btn-primary btn-sm" id="btnChat">Send</button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<input type=hidden id=uname value=@ViewBag.uname>
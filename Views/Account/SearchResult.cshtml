@model FYP.Models.Search
@{
    Layout = null;
}
<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<link href="~/Content/bootstrap.css" rel="stylesheet" />
<link href="~/Content/search.css" rel="stylesheet" />
<script src="~/Scripts/bootstrap.js"></script>
<link href="~/Content/Chat.css" rel="stylesheet" />
<script src="~/Scripts/jquery.signalR-2.0.0.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="/signalr/hubs"></script>
<script type="text/javascript">
    function getCurrentDate() {
        var d = new Date($.now());
        var day = d.getDate() + "";
        if (day.length == 1) {
            day = "0" + day;
        }
        var month = (d.getMonth() + 1) + "";
        if (month.length == 1) {
            month = "0" + month;
        }
        var year = d.getFullYear() + "";

        var hours = d.getHours() + "";
        if (hours.length == 1) {
            hours = "0" + hours;
        }
        var minutes = d.getMinutes() + "";
        if (minutes.length == 1) {
            minutes = "0" + minutes;
        }
        var seconds = d.getSeconds() + "";
        if (seconds.length == 1) {
            seconds = "0" + seconds;
        }
        var fullDate = day + "/" + month + "/" + year + " " + hours + ":" + minutes + ":" + seconds;
        return fullDate;
    }
    function abc(chatHub) {
        var b = $("#uname").val();
        $(document).ready(function connectToChatting() {
            name = b;
            chatHub.server.connect(name);
        })
        $(document).on('click', '#btnChat', function () {
            var y = $(this).parent().parent().parent().parent().parent();
            var z = $(y).find("#chatTitle").text();           
            var x = $(y).find("#chatMsg").val();
            if (x != "") {
                var app = $(y).find("#app");
                $(app).append('<div class="row msg_container base_receive"><div class="col-md-2 col-xs-2 avatar"><img src="' + 'Account/GetImage?UserName=' + b + '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive"><p>' + x + '</p><time datetime="2009-11-13T20:00">' + z + ' • ' + getCurrentDate() + '</time></div></div></div>');
                $(y).find("#chatMsg").val(null);
                var date = getCurrentDate();
                chatHub.server.sendMessage(z, x, date);
            }
        })
        $('.status').click(function () {
            var y = $(this).text();
            var x = $(this).siblings().text();
            var z = $('.chatBox').children('.container').length;
            var totalChats = $('.chatBox').children('.container');           
            if ("Chat" == y) {
                if (totalChats.length == 0) {
                    chatHub.server.getOldMessages(b, x);
                    $('.chatBox').append('<div class="container"><div class="row chat-window col-xs-5 col-md-4" id="chat_window_1" style="margin-left:10px"><div class="col-xs-12 col-md-12"><div class="panel panel-default"><div class="panel-heading top-bar"><div class="col-md-8 col-xs-8"><h3 class="panel-title"><span class="glyphicon glyphicon-comment" >Chat-</span><span id="chatTitle">' + x + '</span></h3></div><div class="col-md-4 col-xs-4" style="text-align: right;"><a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a><a href="#"><span data-id="chat_window_1"></span></a></div></div><div class="panel-body msg_container_base"><div id="app"></div><div class="panel-footer"><div class="input-group"><input id="chatMsg" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." /><span class="input-group-btn"><button class="btn btn-primary btn-sm" id="btnChat">Send</button></span></div></div></div></div></div></div></div>');
                }
                else {
                    var check = 0;
                    for (var i = 0; i < totalChats.length; i++) {
                        var chattitle = $(totalChats[i]).find('#chatTitle');
                        if (chattitle.text() == x) {
                            check = 1;
                            var totalChatsvisible = $('.chatBox').children('.container:visible');
                            if (totalChatsvisible.length == 0)
                            {
                                var child = $(totalChats[i]).find("#chat_window_1");
                                $(child).removeClass("chat-window");
                                $(child).removeClass("chat-window1");
                                $(child).removeClass("chat-window2");
                                $(child).addClass("chat-window");
                                $(totalChats[i]).show();
                            }
                            else if (totalChatsvisible.length == 1) {
                                if ($(totalChats[i])[0] != $(totalChatsvisible)[0]) {
                                    var child = $(totalChats[i]).find("#chat_window_1");
                                    $(child).removeClass("chat-window");
                                    $(child).removeClass("chat-window1");
                                    $(child).removeClass("chat-window2");
                                    $(child).addClass("chat-window1");
                                    $(totalChats[i]).show();
                                }
                            }
                            else {
                                if (($(totalChats[i])[0] != $(totalChatsvisible[0])[0])&&($(totalChats[i])[0] != $(totalChatsvisible[1])[0])) {
                                    var child = $(totalChats[i]).find("#chat_window_1");
                                    $(child).removeClass("chat-window");
                                    $(child).removeClass("chat-window1");
                                    $(child).removeClass("chat-window2");
                                    $(child).addClass("chat-window2");
                                    $(totalChats[i]).show();
                                    var totalChatsvisible1 = $('.chatBox').children('.container:visible');
                                    for (var i = 0; i < totalChatsvisible1.length; i++) {
                                        
                                        var child = $(totalChatsvisible1[i]).find(".chat-window2");
                                        var title = $(child).find("#chatTitle");
                                        if (title.text() != "" && title.text()!=x) { 
                                            $(totalChatsvisible1[i]).hide();
                                        }
                                    }
                                }
                            }
                        }
                    }
                    if (check == 0) {
                        if (z == 1) {
                            chatHub.server.getOldMessages(b, x);
                            $('.chatBox').append('<div class="container"><div class="row chat-window1 col-xs-5 col-md-4" id="chat_window_1" ><div class="col-xs-12 col-md-12"><div class="panel panel-default"><div class="panel-heading top-bar"><div class="col-md-8 col-xs-8"><h3 class="panel-title"><span class="glyphicon glyphicon-comment" >Chat-</span><span id="chatTitle">' + x + '</span></h3></div><div class="col-md-4 col-xs-4" style="text-align: right;"><a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a><a href="#"><span data-id="chat_window_1"></span></a></div></div><div class="panel-body msg_container_base"><div id="app"></div><div class="panel-footer"><div class="input-group"><input id="chatMsg" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." /><span class="input-group-btn"><button class="btn btn-primary btn-sm" id="btnChat">Send</button></span></div></div></div></div></div></div></div>');
                            
                        }
                        else if (z == 2) {
                            $('.chatBox').append('<div class="container"><div class="row chat-window2 col-xs-5 col-md-4" id="chat_window_1"><div class="col-xs-12 col-md-12"><div class="panel panel-default"><div class="panel-heading top-bar"><div class="col-md-8 col-xs-8"><h3 class="panel-title"><span class="glyphicon glyphicon-comment" >Chat-</span><span id="chatTitle">' + x + '</span></h3></div><div class="col-md-4 col-xs-4" style="text-align: right;"><a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a><a href="#"><span data-id="chat_window_1"></span></a></div></div><div class="panel-body msg_container_base"><div id="app"></div><div class="panel-footer"><div class="input-group"><input id="chatMsg" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." /><span class="input-group-btn"><button class="btn btn-primary btn-sm" id="btnChat">Send</button></span></div></div></div></div></div></div></div>');
                            chatHub.server.getOldMessages(b, x);
                        }
                        else {
                            var totalChatsvisible = $('.chatBox').children('.container:visible');
                            if (totalChatsvisible.length == 0) {
                                $('.chatBox').append('<div class="container"><div class="row chat-window col-xs-5 col-md-4" id="chat_window_1" style="margin-left:10px"><div class="col-xs-12 col-md-12"><div class="panel panel-default"><div class="panel-heading top-bar"><div class="col-md-8 col-xs-8"><h3 class="panel-title"><span class="glyphicon glyphicon-comment" >Chat-</span><span id="chatTitle">' + x + '</span></h3></div><div class="col-md-4 col-xs-4" style="text-align: right;"><a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a><a href="#"><span data-id="chat_window_1"></span></a></div></div><div class="panel-body msg_container_base"><div id="app"></div><div class="panel-footer"><div class="input-group"><input id="chatMsg" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." /><span class="input-group-btn"><button class="btn btn-primary btn-sm" id="btnChat">Send</button></span></div></div></div></div></div></div></div>');
                                chatHub.server.getOldMessages(b, x);
                            }
                            else if (totalChatsvisible.length == 1) {
                                $('.chatBox').append('<div class="container"><div class="row chat-window1 col-xs-5 col-md-4" id="chat_window_1" style="margin-left:10px"><div class="col-xs-12 col-md-12"><div class="panel panel-default"><div class="panel-heading top-bar"><div class="col-md-8 col-xs-8"><h3 class="panel-title"><span class="glyphicon glyphicon-comment" >Chat-</span><span id="chatTitle">' + x + '</span></h3></div><div class="col-md-4 col-xs-4" style="text-align: right;"><a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a><a href="#"><span data-id="chat_window_1"></span></a></div></div><div class="panel-body msg_container_base"><div id="app"></div><div class="panel-footer"><div class="input-group"><input id="chatMsg" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." /><span class="input-group-btn"><button class="btn btn-primary btn-sm" id="btnChat">Send</button></span></div></div></div></div></div></div></div>');
                                chatHub.server.getOldMessages(b, x);
                            }
                            else if (totalChatsvisible.length == 2) {
                                $('.chatBox').append('<div class="container"><div class="row chat-window2 col-xs-5 col-md-4" id="chat_window_1" style="margin-left:10px"><div class="col-xs-12 col-md-12"><div class="panel panel-default"><div class="panel-heading top-bar"><div class="col-md-8 col-xs-8"><h3 class="panel-title"><span class="glyphicon glyphicon-comment" >Chat-</span><span id="chatTitle">' + x + '</span></h3></div><div class="col-md-4 col-xs-4" style="text-align: right;"><a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a><a href="#"><span data-id="chat_window_1"></span></a></div></div><div class="panel-body msg_container_base"><div id="app"></div><div class="panel-footer"><div class="input-group"><input id="chatMsg" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." /><span class="input-group-btn"><button class="btn btn-primary btn-sm" id="btnChat">Send</button></span></div></div></div></div></div></div></div>');
                            }
                            else {
                                //   var totalChatsvisible1 = $('.chatBox').children('.container:visible');
                                for (var i = 0; i < totalChatsvisible.length; i++) {
                                    var child = $(totalChatsvisible[i]).find(".chat-window2");
                                    var title = $(child).find("#chatTitle");
                                    if (title.text() != "") {
                                        $(totalChatsvisible[i]).hide();
                                    }
                                }
                                //    var totalChats = $('.chatBox').children('.container');
                                var check1 = 0;
                                for (var i = 0; i < totalChats.length; i++) {
                                    var chattitle = $(totalChats[i]).find('#chatTitle');
                                    if (chattitle.text() == x) {
                                        check1 = 1;
                                        var child = $(totalChats[i]).find("#chat_window_1");
                                        $(child).removeClass("chat-window");
                                        $(child).removeClass("chat-window1");
                                        $(child).removeClass("chat-window2");
                                        $(child).addClass("chat-window2");
                                        $(totalChats[i]).show();
                                    }
                                }
                                if (check1 == 0) {
                                    $('.chatBox').append('<div class="container"><div class="row chat-window2 col-xs-5 col-md-4" id="chat_window_1" style="margin-left:10px"><div class="col-xs-12 col-md-12"><div class="panel panel-default"><div class="panel-heading top-bar"><div class="col-md-8 col-xs-8"><h3 class="panel-title"><span class="glyphicon glyphicon-comment" >Chat-</span><span id="chatTitle">' + x + '</span></h3></div><div class="col-md-4 col-xs-4" style="text-align: right;"><a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a><a href="#"><span data-id="chat_window_1"></span></a></div></div><div class="panel-body msg_container_base"><div id="app"></div><div class="panel-footer"><div class="input-group"><input id="chatMsg" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." /><span class="input-group-btn"><button class="btn btn-primary btn-sm" id="btnChat">Send</button></span></div></div></div></div></div></div></div>');
                                    chatHub.server.getOldMessages(b, x);
                                }
                            }
                        }
                    }
                }
            }
        });
                $(document).on('keypress', '#chatMsg',function (e) {
            if (e.which == 13) {
                $('#btnChat').click();
            }
        });
    }
    function registerClientMethods(chatHub) {
        // Calls when user successfully logged in
        chatHub.client.onConnected = function (id, userName, allUsers, messages) {
            var arr1 = document.getElementsByClassName('username');
            var arr2 = document.getElementsByClassName('status');
            for (var i = 0; i < arr1.length; i++) {
                var t = arr1[i].innerHTML;                
                for (var j = 0; j < allUsers.length; j++) {
                    if (t == allUsers[j].UserName) {
                        arr2[i].innerHTML = "Chat";
                        arr2[i].className = "status pull-right btn-primary";
                    }
                }
            }
        }
        chatHub.client.onNewUserConnected = function (id, userName) {
            var arr1 = document.getElementsByClassName('username');
            var arr2 = document.getElementsByClassName('status');

            for (var i = 0; i < arr1.length; i++) {
                var t = arr1[i].innerHTML;
                if (t == userName) {
                    arr2[i].innerHTML = "Chat";
                    arr2[i].className = "status pull-right btn-primary";
                }
                else if(arr2[i].innerHTML!="Chat"){
                    arr2[i].innerHTML = "Send Mail";
                    arr2[i].className = "status pull-right btn-danger";
                }
            }
        }
        chatHub.client.onUserDisconnected = function (id,userName) {
            var arr1 = document.getElementsByClassName('username');
            var arr2 = document.getElementsByClassName('status');

            for (var i = 0; i < arr1.length; i++) {
                var t = arr1[i].innerHTML;
                if (t == userName) {
                    arr2[i].innerHTML = "Send Mail";
                    arr2[i].className = "status pull-right btn-danger";
                }
            }
        }
        chatHub.client.sendPrivateMessage = function (fromUserId, fromuserName,toUser ,message, previousMessages) {
            var totalChats = $('.chatBox').children('.container');
            var check = 0;
            for (var i = 0; i < totalChats.length; i++) {
                var chattitle1 = $(totalChats[i]).find("#chatTitle");
                if (chattitle1.text() == fromuserName) {
                    var app = $(totalChats[i]).find("#app");
                    $(app).append('<div class="row msg_container base_sent"><div class="col-md-10 col-xs-10"><div class="messages msg_sent"><p>' + message + '</p><time datetime="2009-11-13T20:00">' + fromuserName + ' • 51 min</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' + 'Account/GetImage?UserName=' + toUser + '" class=" img-responsive "></div></div></div>');
                    $(totalChats[i]).show();
                    $(totalChats[i]).find('panel-body').slideDown();
                    check = 1;
                }
            }
            if(totalChats.length==0)
            {
                $('.chatBox').append('<div class="container"><div class="row chat-window col-xs-5 col-md-4" id="chat_window_1" style="margin-left:10px"><div class="col-xs-12 col-md-12"><div class="panel panel-default"><div class="panel-heading top-bar"><div class="col-md-8 col-xs-8"><h3 class="panel-title"><span class="glyphicon glyphicon-comment" >Chat-</span><span id="chatTitle">' + fromuserName + '</span></h3></div><div class="col-md-4 col-xs-4" style="text-align: right;"><a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a><a href="#"><span data-id="chat_window_1"></span></a></div></div><div class="panel-body msg_container_base"><div id="app"></div><div class="panel-footer"><div class="input-group"><input id="chatMsg" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." /><span class="input-group-btn"><button class="btn btn-primary btn-sm" id="btnChat">Send</button></span></div></div></div></div></div></div></div>');
                if (isEmpty(fromuserName)) {
                    var i = 0;
                    for (i = 0; i < previousMessages.length; i++) {
                        var sender = previousMessages[i].From;
                        if (sender == toUser) {
                            $("#app").append('<div class="row msg_container base_receive" ><div class="col-md-2 col-xs-2 avatar"><img src="' + '/Account/GetImage?UserName=' + previousMessages[i].From + '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive" style="background-color:#00CCFF"><p>' + previousMessages[i].MessageText + '</p><time datetime="2009-11-13T20:00">' + previousMessages[i].To + ' •' + previousMessages[i].Date + '</time></div></div></div>');

                        }
                        else {
                        
                            $("#app").append('<div class="row msg_container base_sent" ><div class="col-md-10 col-xs-10"><div class="messages msg_sent" style="background-color:#00FF66"><p>' + previousMessages[i].MessageText + '</p><time datetime="2009-11-13T20:00">' + previousMessages[i].From + ' • ' + previousMessages[i].Date + '</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' + '/Account/GetImage?UserName=' + z + '" class=" img-responsive "></div></div></div>');
                        }
                        $("#app").append('<div class="row msg_container base_sent"><div class="col-md-10 col-xs-10"><div class="messages msg_sent"><p>' + message + '</p><time datetime="2009-11-13T20:00">' + fromuserName + ' • 51 min</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' + 'Account/GetImage?UserName=' + toUser + '" class=" img-responsive "></div></div></div>');
                    }
                }
                else{
                    
                    $this.parents('.panel').find('.panel-body').slideDown();
                    $("#app").append('<div class="row msg_container base_sent"><div class="col-md-10 col-xs-10"><div class="messages msg_sent"><p>' + message + '</p><time datetime="2009-11-13T20:00">' + fromuserName + ' • 51 min</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' + 'Account/GetImage?UserName=' + toUser + '" class=" img-responsive "></div></div></div>');
                }
                
            }
            if (check == 0) {
                var z = $('.chatBox').children('.container:visible').length;
                if (totalChats.length == 1) {
                    alert("Hi");
                    $('.chatBox').append('<div class="container"><div class="row chat-window1 col-xs-5 col-md-4" id="chat_window_1" ><div class="col-xs-12 col-md-12"><div class="panel panel-default"><div class="panel-heading top-bar"><div class="col-md-8 col-xs-8"><h3 class="panel-title"><span class="glyphicon glyphicon-comment" >Chat-</span><span id="chatTitle">' + fromuserName + '</span></h3></div><div class="col-md-4 col-xs-4" style="text-align: right;"><a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a><a href="#"><span data-id="chat_window_1"></span></a></div></div><div class="panel-body msg_container_base"><div id="app"></div><div class="panel-footer"><div class="input-group"><input id="chatMsg" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." /><span class="input-group-btn"><button class="btn btn-primary btn-sm" id="btnChat">Send</button></span></div></div></div></div></div></div></div>');
                    var totalChats = $('.chatBox').children('.container');
                    for (var i = 0; i < totalChats.length; i++) {
                        var chattitle1 = $(totalChats[i]).find("#chatTitle");
                        if (chattitle1.text() == fromuserName) {
                            var app = $(totalChats[i]).find("#app");
                            if (isEmpty(fromuserName)) {
                                var i = 0;
                                for (i = 0; i < previousMessages.length; i++) {
                                    var sender = previousMessages[i].From;
                                    if (sender == toUser) {
                                        $(app).append('<div class="row msg_container base_receive" ><div class="col-md-2 col-xs-2 avatar"><img src="' + '/Account/GetImage?UserName=' + previousMessages[i].From + '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive" style="background-color:#00CCFF"><p>' + previousMessages[i].MessageText + '</p><time datetime="2009-11-13T20:00">' + previousMessages[i].To + ' •' + previousMessages[i].Date + '</time></div></div></div>');

                                    }
                                    else {
                                        $(app).append('<div class="row msg_container base_sent" ><div class="col-md-10 col-xs-10"><div class="messages msg_sent" style="background-color:#00FF66"><p>' + previousMessages[i].MessageText + '</p><time datetime="2009-11-13T20:00">' + previousMessages[i].From + ' • ' + previousMessages[i].Date + '</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' + '/Account/GetImage?UserName=' + z + '" class=" img-responsive "></div></div></div>');
                                    }
                                    $("#app").append('<div class="row msg_container base_sent"><div class="col-md-10 col-xs-10"><div class="messages msg_sent"><p>' + message + '</p><time datetime="2009-11-13T20:00">' + fromuserName + ' • 51 min</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' + 'Account/GetImage?UserName=' + toUser + '" class=" img-responsive "></div></div></div>');
                                }
                            }
                            else {
                                $(app).append('<div class="row msg_container base_sent"><div class="col-md-10 col-xs-10"><div class="messages msg_sent"><p>' + message + '</p><time datetime="2009-11-13T20:00">' + fromuserName + ' • 51 min</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' + 'Account/GetImage?UserName=' + toUser + '" class=" img-responsive "></div></div></div>');
                                $this.parents('.panel').find('panel-body').slideUp();
                            }
                        }
                    }
                }
                else if (totalChats.length == 2) {
                    $('.chatBox').append('<div class="container"><div class="row chat-window2 col-xs-5 col-md-4" id="chat_window_1" style="  bottom:0;right:' + size + 'px;position:fixed;float:left;margin-left:10px;"><div class="col-xs-12 col-md-12"><div class="panel panel-default"><div class="panel-heading top-bar"><div class="col-md-8 col-xs-8"><h3 class="panel-title"><span class="glyphicon glyphicon-comment" >Chat-</span><span id="chatTitle">' + fromuserName + '</span></h3></div><div class="col-md-4 col-xs-4" style="text-align: right;"><a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim"></span></a><a href="#"><span data-id="chat_window_1"></span></a></div></div><div class="panel-body msg_container_base"><div id="app"></div><div class="panel-footer"><div class="input-group"><input id="chatMsg" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." /><span class="input-group-btn"><button class="btn btn-primary btn-sm" id="btnChat">Send</button></span></div></div></div></div></div></div></div>');
                    var totalChats = $('.chatBox').children('.container');
                    for (var i = 0; i < totalChats.length; i++) {
                        var chattitle1 = $(totalChats[i]).find("#chatTitle");
                        if (chattitle1.text() == fromuserName) {
                            var app = $(totalChats[i]).find("#app");
                            if (isEmpty($(fromuserName))) {
                                var i = 0;
                                for (i = 0; i < previousMessages.length; i++) {
                                    var sender = previousMessages[i].From;
                                    if (sender == toUser) {
                                        $(app).append('<div class="row msg_container base_receive" ><div class="col-md-2 col-xs-2 avatar"><img src="' + '/Account/GetImage?UserName=' + previousMessages[i].From + '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive" style="background-color:#00CCFF"><p>' + previousMessages[i].MessageText + '</p><time datetime="2009-11-13T20:00">' + previousMessages[i].To + ' •' + previousMessages[i].Date + '</time></div></div></div>');

                                    }
                                    else {
                                        $(app).append('<div class="row msg_container base_sent" ><div class="col-md-10 col-xs-10"><div class="messages msg_sent" style="background-color:#00FF66"><p>' + previousMessages[i].MessageText + '</p><time datetime="2009-11-13T20:00">' + previousMessages[i].From + ' • ' + previousMessages[i].Date + '</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' + '/Account/GetImage?UserName=' + z + '" class=" img-responsive "></div></div></div>');
                                    }
                                }
                            }
                            else {
                                $(app).append('<div class="row msg_container base_sent"><div class="col-md-10 col-xs-10"><div class="messages msg_sent"><p>' + message + '</p><time datetime="2009-11-13T20:00">' + fromuserName + ' • 51 min</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' + 'Account/GetImage?UserName=' + b + '" class=" img-responsive "></div></div></div>');
                                $this.parents('.panel').find('.panel-body').slideDown();
                                chatHub.server.getOldMessages(b, x);
                            }
                        }
                    }
                }
                else {

                }
            }
            }
        function isEmpty(name) {
            var totalChats = $('.chatBox').children('.container');
            var check = 0;
            var app;
            for (var i = 0; i < totalChats.length; i++) {
                var chattitle1 = $(totalChats[i]).find("#chatTitle");
                if (chattitle1.text() == name) {
                    app = $(totalChats[i]).find("#app");
                }
            }
            return !$.trim(app.html());
        }
        chatHub.client.addOldMessages = function (messages,reciever) {
            
            var totalChats = $('.chatBox').children('.container');
            var check = 0;
            var app;
            var chattitle1;
            for (var i = 0; i < totalChats.length; i++) {
                chattitle1 = $(totalChats[i]).find("#chatTitle");
                if (chattitle1.text() == reciever) {
                    alert(chattitle1.text());
                    app = $(totalChats[i]).find("#app");
                }
            }
            if (isEmpty(chattitle1.text())) {
                var b = $("#uname").val();
                var i = 0;
                for (i = 0; i < messages.length; i++) {
                    var z = messages[i].From;
                    if (z == b) {
                        $(app).append('<div class="row msg_container base_receive" ><div class="col-md-2 col-xs-2 avatar"><img src="' + '/Account/GetImage?UserName=' + messages[i].From + '" class=" img-responsive "></div><div class="col-md-10 col-xs-10"><div class="messages msg_receive" style="background-color:#00CCFF"><p>' + messages[i].MessageText + '</p><time datetime="2009-11-13T20:00">' + messages[i].To + ' •' + messages[i].Date + '</time></div></div></div>');

                    }
                    else {
                        $(app).append('<div class="row msg_container base_sent" ><div class="col-md-10 col-xs-10"><div class="messages msg_sent" style="background-color:#00FF66"><p>' + messages[i].MessageText + '</p><time datetime="2009-11-13T20:00">' + messages[i].From + ' • ' + messages[i].Date + '</time></div></div><div class="col-md-2 col-xs-2 avatar"><img src="' + '/Account/GetImage?UserName=' + z + '" class=" img-responsive "></div></div></div>');
                    }
                }
            }
        }
    }
    $(function () {
        // Declare a proxy to reference the hub.
        var chatHub = $.connection.chatHub;
        registerClientMethods(chatHub);
        // Start Hub
        $.connection.hub.start().done(function () {
            abc(chatHub);
        });
    });
</script>
<script>
    $(document).ready(function () {
        $("#openMoreChats").hide();
    });
</script>
<script>
    $(document).on('click', '.panel-heading span.icon_minim', function (e) {
        var $this = $(this);
        if (!$this.hasClass('panel-collapsed')) {
            $this.parents('.panel').find('.panel-body').slideUp();
            $this.addClass('panel-collapsed');
            $this.removeClass('glyphicon-minus').addClass('glyphicon-plus');
        } else {
            $this.parents('.panel').find('.panel-body').slideDown();
            $this.removeClass('panel-collapsed');
            $this.removeClass('glyphicon-plus').addClass('glyphicon-minus');
        }
    });
    $(document).on('focus', '.panel-footer input.chat_input', function (e) {
        var $this = $(this);
        if ($('#minim_chat_window').hasClass('panel-collapsed')) {
            $this.parents('.panel').find('.panel-body').slideDown();
            $('#minim_chat_window').removeClass('panel-collapsed');
            $('#minim_chat_window').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        }
    });
</script>
<br />
<div class="container">
    <hgroup class="mb20">
        <h1>Search Results</h1>
        <h2 class="lead"><strong class="text-danger">@ViewBag.search.Count</strong> results were found for the search for <strong class="text-danger">@ViewBag.query</strong></h2>
    </hgroup>
    <section class="col-xs-12 col-sm-6 col-md-12">
        @foreach (FYP.Models.Search s in ViewBag.search)
        {
            <article class="search-result row">
                <div class="col-xs-12 col-sm-12 col-md-3">
                    <a href="#" class="thumbnail"><img src=@Url.Action("GetImage", "Account", new { UserName = s.UserName }) /></a>
                </div>
                <div class="col-xs-12 col-sm-12 col-md-2">
                    <ul class="meta-search">
                        <li><i class="glyphicon glyphicon-calendar"></i> <span>@s.Date</span></li>
                        <li><i class="glyphicon glyphicon-time"></i> <span>@s.Time</span></li>
                        <li><i class="glyphicon glyphicon-tags"></i> <span>People</span></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-12 col-md-7 excerpet">
                    <h3>
                        <a href="#" class="username" id="UserNo">@s.UserName</a>
                        <button id="chatButton" class="status pull-right btn-danger" style="font-size:x-large">Send Mail</button>
                    </h3>
                    <p>@s.SearchQuery</p>
                </div>
                <span class="clearfix borda"></span>
            </article>
        }
    </section>
</div>
<div class="chatBox"></div>
<div class="btn-group dropup" id="openMoreChats">
    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
        <span class="glyphicon glyphicon-comment"></span>
        <span class="sr-only">Toggle Dropdown</span>
    </button>
    <ul class="dropdown-menu" role="menu">
    </ul>
</div>
<input type=hidden id=uname value=@ViewBag.uname>